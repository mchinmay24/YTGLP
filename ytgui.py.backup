import customtkinter as ctk
import subprocess
from tkinter import messagebox, filedialog
import os
import threading
import re

# Appearance
ctk.set_appearance_mode("Dark")
ctk.set_default_color_theme("blue")

# Default path
default_download_path = os.path.expanduser("~/Music")
download_path = default_download_path

# Button colors
button_color = "#9141ac"
hover_button_color = "#7e3795"

# Simple tooltip class for CustomTkinter widgets
class ToolTip:
    def __init__(self, widget, text):
        self.widget = widget
        self.text = text
        self.tipwindow = None
        self.id = None
        self.x = self.y = 0
        self.widget.bind("<Enter>", self.show_tip)
        self.widget.bind("<Leave>", self.hide_tip)

    def show_tip(self, event=None):
        if self.tipwindow or not self.text:
            return
        x = self.widget.winfo_rootx() + 20
        y = self.widget.winfo_rooty() + self.widget.winfo_height() + 10
        self.tipwindow = tw = ctk.CTkToplevel(self.widget)
        tw.overrideredirect(True)
        tw.geometry(f"+{x}+{y}")
        label = ctk.CTkLabel(tw, text=self.text, fg_color="#333333", text_color="white", corner_radius=5, padx=5, pady=3)
        label.pack()

    def hide_tip(self, event=None):
        if self.tipwindow:
            self.tipwindow.destroy()
            self.tipwindow = None

def choose_folder():
    global download_path
    selected_folder = filedialog.askdirectory(initialdir=default_download_path)
    if selected_folder:
        download_path = selected_folder
        folder_label.configure(text=f"Download to: {download_path}")

def run_command(command, log_widget, on_progress=None):
    process = subprocess.Popen(command, stdout=subprocess.PIPE, stderr=subprocess.STDOUT, text=True, bufsize=1)
    for line in process.stdout:
        log_widget.insert("end", line)
        log_widget.see("end")
        if on_progress:
            on_progress(line)
    process.wait()
    return process.returncode

def parse_progress(line):
    match = re.search(r'\b(\d{1,3}\.\d)%', line)
    if match:
        try:
            percent = float(match.group(1)) / 100
            progress_bar.set(percent)
        except:
            pass

def on_format_change(choice):
    global delete_tooltip  # Fix: declare global before usage
    if choice == "default":
        delete_checkbox.configure(state="disabled")
        delete_checkbox.deselect()
        tooltip_text = "Would be stupid to delete original file without any conversion selected, I am taking that freedom away from you"
        # Attach tooltip
        delete_tooltip = ToolTip(delete_checkbox, tooltip_text)
    else:
        delete_checkbox.configure(state="normal")
        delete_checkbox.select()
        # Remove tooltip if exists
        if 'delete_tooltip' in globals():
            delete_tooltip.hide_tip()
            delete_tooltip = None

def download_video():
    url = url_entry.get()
    start_time = start_time_entry.get()
    end_time = end_time_entry.get()
    selected_format = format_option_menu.get()
    delete_original = delete_checkbox.get()

    if not url:
        messagebox.showwarning("Missing URL", "Please enter a YouTube URL.")
        return

    log_box.delete("1.0", "end")
    progress_bar.set(0)

    def task():
        # Step 1: Download
        output_template = os.path.join(download_path, "%(title)s.%(ext)s")
        download_cmd = [
            'yt-dlp',
            '-f', 'bestvideo+bestaudio/best',
            '-o', output_template,
            '--progress-template', 'download:%(progress._percent_str)s'
        ]

        if start_time and end_time:
            section_arg = f"*{start_time}-{end_time}"
            download_cmd += ['--download-sections', section_arg, '--force-keyframes-at-cuts']

        download_cmd.append(url)

        log_box.insert("end", "[Starting yt-dlp download...]\n")
        if run_command(download_cmd, log_box, on_progress=parse_progress) != 0:
            messagebox.showerror("Error", "Download failed.")
            return

        # Step 2: Get filename
        try:
            filename_cmd = [
                'yt-dlp', '--print', 'filename',
                '-f', 'bestvideo+bestaudio/best',
                '-o', output_template,
                url
            ]
            downloaded_file = subprocess.check_output(filename_cmd).decode().strip()
        except Exception:
            messagebox.showerror("Error", "Could not determine downloaded filename.")
            return

        # Step 3: Convert using ffmpeg (if not default)
        if selected_format != "default":
            base_name, _ = os.path.splitext(downloaded_file)
            converted_file = f"{base_name}.{selected_format}"

            log_box.insert("end", f"[Converting to {selected_format}...]\n")
            progress_bar.set(0)
            if run_command(['ffmpeg', '-y', '-i', downloaded_file, converted_file], log_box) != 0:
                messagebox.showerror("Error", f"Conversion to {selected_format} failed.")
                return

            # Step 4: Delete original if needed
            if delete_original:
                try:
                    os.remove(downloaded_file)
                    log_box.insert("end", "[Original file deleted.]\n")
                except Exception as e:
                    log_box.insert("end", f"[Failed to delete original file: {e}]\n")
        else:
            log_box.insert("end", "[Download completed with no conversion.]\n")

        progress_bar.set(1)
        if selected_format == "default":
            messagebox.showinfo("Success", "Download completed with no conversion.")
        else:
            messagebox.showinfo("Success", f"Downloaded and converted to {selected_format}.")

    threading.Thread(target=task, daemon=True).start()

# App window
app = ctk.CTk()
app.title("YT Video Downloader")
app.geometry("600x750")
app.configure(fg_color="#2e2e32")
app.attributes("-alpha", 0.95)

# UI widgets
ctk.CTkLabel(app, text="YouTube URL:", font=("Arial", 14), text_color="white").pack(pady=(15, 5))
url_entry = ctk.CTkEntry(app, width=500, fg_color="#3a3a3f", border_color="#5a5a5f")
url_entry.pack()

# Format and checkbox in a horizontal frame
format_frame = ctk.CTkFrame(app, fg_color="transparent")
format_frame.pack(pady=(15, 5))

ctk.CTkLabel(format_frame, text="Convert To Format:", font=("Arial", 14), text_color="white").grid(row=0, column=0, padx=5, pady=5)
format_option_menu = ctk.CTkOptionMenu(
    format_frame,
    values=["default", "mp4", "mp3", "mkv", "webm", "wav"],
    fg_color="#3a3a3f",
    button_color="#5a5a5f",
    command=on_format_change
)
format_option_menu.set("default")
format_option_menu.grid(row=0, column=1, padx=5)

delete_checkbox = ctk.CTkCheckBox(format_frame, text="Delete original after conversion", text_color="white")
delete_checkbox.grid(row=0, column=2, padx=10)
delete_checkbox.configure(state="disabled")

# Time inputs
ctk.CTkLabel(app, text="Start Time (e.g. 00:01:00):", font=("Arial", 14), text_color="white").pack(pady=(15, 5))
start_time_entry = ctk.CTkEntry(app, width=300, fg_color="#3a3a3f", border_color="#5a5a5f")
start_time_entry.pack()

ctk.CTkLabel(app, text="End Time (e.g. 00:03:00):", font=("Arial", 14), text_color="white").pack(pady=(10, 5))
end_time_entry = ctk.CTkEntry(app, width=300, fg_color="#3a3a3f", border_color="#5a5a5f")
end_time_entry.pack()

folder_label = ctk.CTkLabel(app, text=f"Download to: {default_download_path}", font=("Arial", 12), text_color="lightgray")
folder_label.pack(pady=(15, 5))

ctk.CTkButton(app, text="Choose Folder", command=choose_folder, fg_color=button_color, hover_color=hover_button_color).pack()

ctk.CTkButton(app, text="Download", command=download_video, fg_color=button_color, hover_color=hover_button_color).pack(pady=10)

progress_bar = ctk.CTkProgressBar(app, width=500)
progress_bar.set(0)
progress_bar.pack(pady=(10, 10))

ctk.CTkLabel(app, text="Download Log:", font=("Arial", 14), text_color="white").pack(pady=(5, 5))
log_box = ctk.CTkTextbox(app, width=550, height=200, fg_color="#1e1e22", text_color="white")
log_box.pack(pady=(0, 20))

app.mainloop()

